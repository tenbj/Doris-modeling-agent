# Doris数据仓库分层规范配置

# 数据分层定义
layers:
  # ODS层 - 操作数据存储层
  ods:
    name: "ODS - Operational Data Store"
    description: "操作数据层，原始数据接入层，保持源系统数据原貌"
    naming_pattern: "ods_{source_system}_{table_name}"
    table_model: "DUPLICATE KEY"
    partition_strategy: "RANGE按日期分区"
    retention_days: 7  # 数据保留天数
    features:
      - "1:1映射源表结构"
      - "不做业务逻辑处理"
      - "仅做基础数据类型转换"
      - "添加ETL控制字段"
    required_fields:
      - name: "etl_date"
        type: "DATE"
        comment: "数据日期/业务日期"
      - name: "create_time"
        type: "DATETIME"
        comment: "数据入库时间"
    example_tables:
      - "ods_crm_customer"
      - "ods_erp_order"
      - "ods_log_user_behavior"

  # DWD层 - 明细数据层
  dwd:
    name: "DWD - Data Warehouse Detail"
    description: "明细数据层，完成数据清洗、标准化、整合"
    naming_pattern: "dwd_{subject}_{entity}"
    table_model: "DUPLICATE KEY / UNIQUE KEY"
    partition_strategy: "RANGE按日期分区"
    retention_days: 90
    features:
      - "数据清洗（去重、去空、异常值处理）"
      - "数据标准化（统一编码、格式）"
      - "维度退化（适当冗余维度字段）"
      - "添加代理键"
      - "业务规则应用"
    required_fields:
      - name: "dwd_id"
        type: "BIGINT"
        comment: "DWD层代理主键"
      - name: "data_date"
        type: "DATE"
        comment: "数据日期"
      - name: "etl_time"
        type: "DATETIME"
        comment: "ETL处理时间"
    business_rules:
      - "遵循第三范式，但允许适度冗余"
      - "一个业务实体一张表"
      - "记录粒度：原子级别"
    example_tables:
      - "dwd_trade_order_detail"  # 交易订单明细
      - "dwd_user_login_log"      # 用户登录日志
      - "dwd_product_inventory"    # 产品库存明细

  # DWS层 - 汇总数据层
  dws:
    name: "DWS - Data Warehouse Summary"
    description: "汇总数据层，按主题构建汇总宽表"
    naming_pattern: "dws_{subject}_{grain}_{aggregate}"
    table_model: "AGGREGATE KEY / UNIQUE KEY"
    partition_strategy: "RANGE按日期分区"
    retention_days: 365
    features:
      - "按主题域汇总"
      - "宽表设计（减少JOIN操作）"
      - "常用指标预计算"
      - "多粒度汇总（日、周、月）"
    required_fields:
      - name: "stat_date"
        type: "DATE"
        comment: "统计日期"
      - name: "grain_type"
        type: "VARCHAR(20)"
        comment: "汇总粒度：day/week/month"
      - name: "update_time"
        type: "DATETIME"
        comment: "更新时间"
    aggregation_types:
      - "SUM - 求和"
      - "COUNT - 计数"
      - "MAX/MIN - 最大最小值"
      - "AVG - 平均值"
      - "BITMAP_UNION - 去重计数（UV）"
      - "HLL_UNION - 基数估算"
    example_tables:
      - "dws_trade_user_order_1d"   # 用户订单日汇总
      - "dws_traffic_page_stat_1d"  # 页面流量日统计
      - "dws_product_sales_1d"      # 产品销售日汇总

  # ADS层 - 应用数据服务层
  ads:
    name: "ADS - Application Data Service"
    description: "应用数据服务层，面向具体业务场景"
    naming_pattern: "ads_{business_scene}_{indicator}"
    table_model: "AGGREGATE KEY"
    partition_strategy: "RANGE按日期分区或不分区"
    retention_days: 730  # 2年
    features:
      - "高度聚合"
      - "面向报表/大屏/应用"
      - "可以是指标表或宽表"
      - "直接对外提供查询服务"
    required_fields:
      - name: "report_date"
        type: "DATE"
        comment: "报表日期"
      - name: "refresh_time"
        type: "DATETIME"
        comment: "刷新时间"
    use_cases:
      - "管理驾驶舱"
      - "运营报表"
      - "业务监控大屏"
      - "数据API服务"
    example_tables:
      - "ads_dashboard_gmv_summary"      # GMV汇总看板
      - "ads_operation_user_portrait"    # 用户画像
      - "ads_monitor_realtime_sales"     # 实时销售监控

  # DIM层 - 维度层
  dim:
    name: "DIM - Dimension"
    description: "维度层，管理维度数据（必须使用SCD Type 2拉链表）"
    naming_pattern: "dim_{dimension_name}"
    table_model: "UNIQUE KEY"
    partition_strategy: "不分区或按月分区"
    retention_days: -1  # 永久保留
    features:
      - "维度数据管理"
      - "支持缓慢变化维度（SCD Type 2）"
      - "拉链表设计"
      - "历史数据追溯"
    required_fields:
      - name: "start_date"
        type: "DATE"
        comment: "生效日期"
        required: true
      - name: "end_date"
        type: "DATE"
        comment: "失效日期，当前记录为9999-12-31"
        required: true
      - name: "is_current"
        type: "TINYINT"
        comment: "当前有效标识：1=当前有效，0=历史记录"
        required: true
    unique_key_rule: "维度主键 + start_date"
    scd_type: "Type 2 - 拉链表"
    example_tables:
      - "dim_user_info"        # 用户信息维度
      - "dim_product_info"     # 产品信息维度
      - "dim_store_info"       # 门店信息维度
      - "dim_region"           # 地区维度

# Doris表模型说明
table_models:
  duplicate_key:
    name: "明细模型 (Duplicate Key)"
    description: "数据完全按照导入文件进行存储，不做任何聚合"
    use_cases:
      - "原始数据存储（ODS层）"
      - "明细数据（DWD层）"
      - "日志数据"
    syntax: "DUPLICATE KEY(col1, col2, ...)"

  aggregate_key:
    name: "聚合模型 (Aggregate Key)"
    description: "导入时会按照Key列进行分组聚合"
    use_cases:
      - "汇总统计（DWS层）"
      - "指标报表（ADS层）"
      - "实时OLAP"
    syntax: "AGGREGATE KEY(col1, col2, ...)"
    aggregate_functions:
      - "SUM"
      - "MAX"
      - "MIN"
      - "REPLACE"
      - "BITMAP_UNION"
      - "HLL_UNION"

  unique_key:
    name: "主键唯一模型 (Unique Key)"
    description: "保证Key列唯一性，相同Key的记录会被覆盖"
    use_cases:
      - "维度表（DIM层）"
      - "需要更新的明细表"
      - "去重场景"
    syntax: "UNIQUE KEY(col1, col2, ...)"

# 分区分桶策略
partitioning:
  range_partition:
    description: "范围分区，常用于日期字段"
    example: |
      PARTITION BY RANGE(date_column) (
        PARTITION p20240101 VALUES LESS THAN ('2024-01-02'),
        PARTITION p20240102 VALUES LESS THAN ('2024-01-03')
      )
    best_practices:
      - "按天分区：适用于日增量数据"
      - "按月分区：适用于历史数据或维度表"
      - "分区数量建议不超过1000个"

  hash_distribution:
    description: "哈希分桶，用于数据分布"
    example: "DISTRIBUTED BY HASH(column_name) BUCKETS 10"
    best_practices:
      - "选择高基数字段作为分桶键"
      - "避免数据倾斜"
      - "分桶数建议：数据量(GB) * 0.8 ~ 1.2"

# 数据类型映射
data_type_mapping:
  numeric:
    - name: "TINYINT"
      range: "-128 ~ 127"
      size: "1 byte"
    - name: "SMALLINT"
      range: "-32768 ~ 32767"
      size: "2 bytes"
    - name: "INT"
      range: "-2^31 ~ 2^31-1"
      size: "4 bytes"
    - name: "BIGINT"
      range: "-2^63 ~ 2^63-1"
      size: "8 bytes"
    - name: "DECIMAL(M,D)"
      description: "精确小数，M总位数，D小数位数"
      example: "DECIMAL(10,2)"

  string:
    - name: "CHAR(N)"
      description: "定长字符串，N最大255"
    - name: "VARCHAR(N)"
      description: "变长字符串，N最大65533"
    - name: "STRING"
      description: "变长字符串，最大2GB"

  datetime:
    - name: "DATE"
      format: "YYYY-MM-DD"
      range: "0000-01-01 ~ 9999-12-31"
    - name: "DATETIME"
      format: "YYYY-MM-DD HH:MM:SS"
      range: "0000-01-01 00:00:00 ~ 9999-12-31 23:59:59"

  boolean:
    - name: "BOOLEAN"
      values: "TRUE / FALSE"

# 命名规范
naming_conventions:
  table_name:
    rule: "小写字母 + 下划线"
    pattern: "{layer}_{subject/source}_{entity}"
    examples:
      - "ods_crm_customer"
      - "dwd_trade_order"
      - "dws_user_behavior_1d"
      - "dim_product_info"

  column_name:
    rule: "小写字母 + 下划线"
    reserved_words: "避免使用SQL保留字"
    examples:
      - "user_id"
      - "order_amount"
      - "create_time"

  file_name:
    design: "{layer}_{table_name}_design_{date}.md"
    schema: "{layer}_{table_name}_schema.yaml"
    ddl: "{layer}_{table_name}_ddl.sql"
    dml: "{layer}_{table_name}_dml.sql"

# ETL更新策略
etl_strategies:
  full_load:
    name: "全量加载"
    description: "每次加载全部数据"
    use_cases: ["维度表", "小数据量的事实表"]
    method: "TRUNCATE + INSERT"

  incremental_load:
    name: "增量加载"
    description: "只加载新增和变更的数据"
    use_cases: ["大数据量事实表", "日志表"]
    method: "INSERT (基于时间戳或ID)"

  scd_type2:
    name: "拉链表更新"
    description: "维度缓慢变化处理"
    use_cases: ["所有DIM层表"]
    method: |
      1. UPDATE旧记录：设置end_date和is_current=0
      2. INSERT新记录：设置start_date和is_current=1

