# {表名}数据模型设计方案

## 一、业务背景

### 1.1 业务目标
[描述该表/模型要解决的业务问题]

### 1.2 业务场景
[描述主要的业务应用场景]

### 1.3 数据范围
- **时间范围**：[如：近1年数据]
- **业务范围**：[如：全部门店/特定区域]
- **数据量级**：[如：日增量约XX万条]

## 二、数据分层设计

### 2.1 所属层级
- **数据层**：{ODS/DWD/DWS/ADS/DIM}
- **主题域**：{如：交易域/用户域/流量域}
- **表名**：`{layer}_{subject}_{table_name}`

### 2.2 层级定位
[说明该表在数据流转中的位置和作用]

## 三、数据模型设计

### 3.1 实体关系
```
[使用文本或简图描述实体关系]
例如：
订单事实表 ←→ 用户维度表
    ↓
订单明细表
```

### 3.2 粒度定义
- **数据粒度**：[如：一行代表一个订单/一个用户的日汇总]
- **时间粒度**：[如：天/小时/实时]
- **统计周期**：[如：自然日/自然月]

### 3.3 主键设计
- **主键字段**：{key_columns}
- **唯一性保证**：[说明如何保证主键唯一性]

## 四、字段设计

### 4.1 字段清单

| 字段名 | 数据类型 | 是否必填 | 字段说明 | 来源表/计算逻辑 |
|--------|----------|----------|----------|----------------|
| {field_name} | {data_type} | {Y/N} | {description} | {source} |
| ... | ... | ... | ... | ... |

### 4.2 字段分类

#### 维度字段
- {dimension_field_1}：{description}
- {dimension_field_2}：{description}

#### 度量字段
- {metric_field_1}：{description}
- {metric_field_2}：{description}

#### 时间字段
- {date_field}：{description}

#### ETL控制字段
- etl_date / data_date：数据日期
- create_time / etl_time：入库时间
- update_time：更新时间

#### 拉链表字段（仅DIM层）
- start_date：生效日期
- end_date：失效日期（当前记录为'9999-12-31'）
- is_current：当前有效标识（1=当前有效，0=历史记录）

## 五、数据来源

### 5.1 上游数据源

| 源表名 | 表类型 | 关联方式 | 使用字段 | 备注 |
|--------|--------|----------|----------|------|
| {source_table} | {ODS/DWD/DIM} | {JOIN/UNION} | {fields} | {note} |

### 5.2 数据加工逻辑

#### 数据清洗规则
1. **去重**：[描述去重逻辑]
2. **去空**：[描述空值处理规则]
3. **异常值处理**：[描述异常值判断和处理]

#### 数据转换规则
1. **字段映射**：
   - 源字段 → 目标字段
2. **类型转换**：
   - [描述需要类型转换的字段]
3. **编码转换**：
   - [描述编码标准化规则]

#### 业务规则应用
1. **规则1**：[描述业务规则]
2. **规则2**：[描述业务规则]

#### 计算逻辑（汇总表）
1. **指标1**：
   - 计算公式：{formula}
   - 聚合函数：{SUM/COUNT/AVG/MAX/MIN}
2. **指标2**：
   - 计算公式：{formula}

## 六、Doris表设计

### 6.1 表模型选择
- **模型类型**：{DUPLICATE KEY / AGGREGATE KEY / UNIQUE KEY}
- **选择理由**：[说明为什么选择该模型]

### 6.2 分区策略
- **分区类型**：RANGE分区
- **分区字段**：{partition_column}
- **分区粒度**：{按天/按月}
- **分区保留**：{保留天数/月数}

### 6.3 分桶策略
- **分桶方式**：HASH分桶
- **分桶字段**：{bucket_column}
- **分桶数量**：{bucket_num}
- **选择依据**：[说明分桶字段和数量的选择依据]

### 6.4 索引设计
- **排序键**：{sort_columns}
- **Bloom Filter**：{是否启用及字段}

## 七、数据更新策略

### 7.1 更新方式
- **更新类型**：{全量/增量/拉链}
- **更新频率**：{每日/每小时/实时}
- **更新时间**：{如：每天凌晨2点}

### 7.2 增量识别（增量更新）
- **增量字段**：{update_time / id}
- **增量逻辑**：[描述如何识别增量数据]

### 7.3 拉链更新逻辑（仅DIM层）
```sql
-- 步骤1：识别变更记录
-- 步骤2：关闭旧记录（UPDATE end_date, is_current=0）
-- 步骤3：插入新记录（INSERT start_date, is_current=1）
```

### 7.4 数据回刷
- **回刷场景**：[描述需要回刷的场景]
- **回刷范围**：[描述回刷的时间范围]

## 八、依赖关系

### 8.1 上游依赖
- 依赖表1：{table_name} - {ready_time}
- 依赖表2：{table_name} - {ready_time}

### 8.2 下游应用
- 下游表1：{table_name}
- 报表/应用：{application_name}

### 8.3 调度顺序
```
上游表A (T+0 01:00完成)
    ↓
上游表B (T+0 02:00完成)
    ↓
当前表 (T+0 03:00开始)
    ↓
下游表C (T+0 04:00开始)
```

## 九、数据质量

### 9.1 数据完整性
- **主键唯一性检查**
- **必填字段非空检查**
- **数据量检查**：[预期数据量范围]

### 9.2 数据准确性
- **业务规则校验**：[列举需要校验的业务规则]
- **关联一致性校验**：[与维度表或其他表的关联检查]

### 9.3 数据及时性
- **SLA要求**：[数据就绪时间要求]
- **延迟监控**：[监控指标]

### 9.4 拉链表质量（仅DIM层）
- **有效期连续性检查**：前一条记录的end_date = 后一条记录的start_date - 1
- **有效期重叠检查**：同一维度主键不应有时间重叠的记录
- **当前记录唯一性**：每个维度主键只能有一条is_current=1的记录
- **历史记录完整性**：历史记录的end_date不应为'9999-12-31'

## 十、性能优化

### 10.1 查询优化
- **常用查询模式**：[描述主要查询场景]
- **优化措施**：
  - 分区裁剪
  - 排序键优化
  - 预聚合

### 10.2 存储优化
- **压缩策略**：[LZ4/ZSTD]
- **预期压缩比**：[估算]

### 10.3 性能指标
- **查询响应时间**：< {N}秒
- **数据加载时长**：< {N}分钟

## 十一、风险与注意事项

### 11.1 数据风险
- **风险1**：[描述风险及应对措施]
- **风险2**：[描述风险及应对措施]

### 11.2 技术风险
- **风险1**：[描述风险及应对措施]

### 11.3 注意事项
- **注意1**：[重要提示]
- **注意2**：[重要提示]

## 十二、版本记录

| 版本号 | 修改日期 | 修改人 | 修改内容 |
|--------|----------|--------|----------|
| v1.0 | {date} | {author} | 初始版本 |

---

## 附录：参考文档

- [业务需求文档]：`docs/business/{filename}`
- [源数据文档]：`docs/source/{filename}`
- [相关设计文档]：`out/design/{related_design}`

